<link rel="import" href="app/bower_components/polymer/polymer.html">
<link rel="import" href="app/bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="app/bower_components/paper-ripple/paper-ripple.html">

<link rel="import" href="button-element.html">
<link rel="import" href="search-bar.html">
<link rel="import" href="sortable-icon.html">

<link rel="stylesheet" href="less/style.css">
<link rel="stylesheet" href="css/normalize.css">
<link rel="stylesheet" href="css/style.css">

<script src="app/bower_components/jquery/dist/jquery.min.js" type="text/javascript"></script>
<script src="jss/tsorter.min.js" type="text/javascript"></script>

<dom-module id="polymer-table">
    <template>
        <style>
            @import "https://fonts.googleapis.com/css?family=Roboto:400,100,100italic,300,300italic,400italic,500,500italic,700,700italic,900,900italic&subset=latin,cyrillic";

            .table-responsive {
                width: auto;
                min-width: 810px;
                overflow-x: scroll;
                overflow-y: hidden;
                white-space: nowrap;
            }

            h1 {
                padding-bottom: 2%;
                padding-left: 5%;
                margin-bottom: 0;
                margin-top: 2%;
                color: var(--dark-primary-color);
                width: 80%;
                float: left;
            }

            button-element {
                margin-top: 3%;
            }

            #buttonMore {
                float: right;
                margin-right: 2%;
                margin-top: 1%;
            }

            .table > tfoot > tr > td .actions {
                white-space: nowrap;
            }

            #actions, .actions {
                position: absolute;
                right: 0;
                background-color: white;
            }

            .container {
                @apply(--layout-vertical);
            }

            #buttonSearch {
                float: right;
                color: #9C27B0;
                margin-right: 2%;
                margin-top: 1%;
                visibility: var(--visibility-search);
            }

        </style>
        <div class="container wrap">
            <div id="table-header ">
                <h1 class="paper-font-display2">{{ title }}</h1>
                <button-element icon="add-circle" color="orange" title="Nuevo" id="buttonMore"></button-element>
                <paper-icon-button icon="search" title="BÃºsqueda" id="buttonSearch" class="btn-collapse"
                                   on-click="toggleSearchCollapser"></paper-icon-button>
            </div>
            <search-bar id="searchBar" label="{{searchLabel}}"></search-bar>
            <div class="table-responsive shadow-z-1">
                <table id="table" border="1" class="table table-hover table-mc-indigo"/>
            </div>
        </div>
    </template>

    <script>
        (function() {
            Polymer({
                is: 'polymer-table',

                //attributes that the table element has
                properties: {
                    actionFields: Object,
                    data: Object,
                    entityName: String,
                    form: String,
                    headers: Object,
                    selected: Number,
                    title: String,
                    tableActions: {type: Boolean, value: false},
                    entities: {type: Object, observer: 'entitiesChanged'}
                },

                listeners: {
                    'dispatch-crud-event': 'crudEventHandler',
                    'action-Nuevo': 'actionNewFormHandler'
                },

                actionNewFormHandler: function() {
                    this.fire('create-New-Form', {
                        'form': this.form,
                        'table': this,
                    });
                },

                crudEventHandler: function(e) {
                    e.detail.table = this;
                    this.fire(e.detail.event, e.detail);
                },

                attached: function() {
                    this.async(function() {
                        // code that formerly resided in `domReady`
                        if (this.tableActions == true) {
                            this.$.buttonMore.hidden = true;
                        }
                    });
                },

                // when the attribute entities changes, this function is called
                entitiesChanged: function(newValue, oldValue) {
                    if (newValue) {
                        this.buildHtmlTable();
                    }
                },

                // Builds the HTML Table,
                // first we build the headers,
                // then with the data retrieved from the iron-ajax, we fill the table
                //adding the search field
                buildHtmlTable: function() {
                    this.fillHeaders();
                    this.fillTable();
                    this.setEventsInRows();
                    var rows = Polymer.dom(this.root).querySelectorAll('.row');
                    this.$.searchBar.setSearchingDataSet(rows);
                    if (this.$.table) {
                        tsorter.create('table');
                    }
                },

                addContentToRow(body, rowName, content, key) {
                    var cell = document.createElement("TD");
                    cell.setAttribute("data-title", key);
                    var cellContent = content;
                    cell.innerHTML = cellContent;
                    body.rows[rowName].appendChild(cell);
                },

                // Function to fill the headers in the table
                fillHeaders: function() {
                    var table = this.$.table;
                    var header = table.createTHead();
                    var row = header.insertRow(0);
                    var finalIndex;


                    for (var index = 0; index < this.headers.length; index++) {

                        var th = document.createElement('th');
                        th.innerHTML = this.headers[index];
                        th.setAttribute('data-tsorter', 'input');
                        var sortableIcon = document.createElement('sortable-icon');
                        var ripple = document.createElement('paper-ripple');
                        th.appendChild(ripple);
                        th.appendChild(sortableIcon);
                        th.addEventListener('sort-clicked', function() {
                            this.click();
                        });

                        row.appendChild(th);
                        finalIndex = index;
                    }

                    var cell = row.insertCell(finalIndex + 1);
                    cell.innerHTML = 'Acciones';
                    this.updateStyles();
                },

                //add the className in an element of the table
                addClass: function(element, classToAdd) {
                    var currentClassValue = element.className;

                    if (currentClassValue.indexOf(classToAdd) == -1) {
                        if ((currentClassValue == null) || (currentClassValue === "")) {
                            element.className = classToAdd;
                        } else {
                            element.className += " " + classToAdd;
                        }
                    }
                },

                // Function to fill the table with data
                fillTable: function() {

                    var number = 0;
                    var body = this.$.table.createTBody();

                    for (var item in this.entities) {

                        var rowName = "elementTableRow" + number;
                        var row = document.createElement("TR");
                        row.setAttribute("id", rowName);
                        row.setAttribute('class', 'row');
                        body.appendChild(row);


                        for (var key in this.entities[item]) {

                            var maskName = key + 'Mask';
                            if (this[maskName]) {
                                var value = this[maskName](this.entities[item][key]);
                                this.addContentToRow(body, rowName, value, key);
                            }

                            else {

                                // If there's an entity inside another entity
                                if (typeof(this.entities[item][key]) == "object" && this.entities[item][key] != null) {
                                    for (var attribute in this.entities[item][key]) {
                                        var content = this.entities[item][key][attribute];
                                        this.addContentToRow(body, rowName, content, key);
                                    }
                                }

                                if (this.entities[item][key] == null) {
                                    var content = '';
                                    this.addContentToRow(body, rowName, content, key);
                                }

                                //putting the id as an attribute of the row, for the selection
                                if (key == "id") {
                                    row.setAttribute("entityId", this.entities[item][key]);
                                    row.setAttribute("entityName", this.entityName);
                                    row.setAttribute("form", this.form);
                                }

                                if (key != "id" && typeof(this.entities[item][key]) != "object") {
                                    var content = this.entities[item][key];
                                    this.addContentToRow(body, rowName, content, key);
                                }
                            }
                        }

                        this.createEditionRows(body, rowName);
                        number++;
                    }
                },

                //Function that removes all the table data and reload it
                reloadTable: function() {
                    this.removeTable();
                    this.fire('reload-data');
                },

                //Function that removes all the content of the body of the table
                removeBodies: function(table) {
                    var bodies = table.tBodies;
                    for (var i = 0; i < bodies.length; i++) {
                        table.removeChild(bodies[i]);
                    }
                },

                //Function that removes the header of the table and then calls removesBodies function
                removeTable: function() {
                    var elem = this.$.table;
                    var header = this.$.table.querySelector('thead');
                    elem.removeChild(header);
                    this.removeBodies(elem);
                },

                // this function set the events for the actions that we are going to do with each row in the table
                setEventsInRows: function() {

                    var rows = this.$.table.querySelector('tbody').querySelectorAll('tr');
                    for (var row in rows) {
                        var rw = rows[row];

                        if (typeof rw == 'object') {

                            //Event listener for the edit action
                            rw.addEventListener('action-Editar', function() {
                                this.className = "selected";
                                var eventCreateForm = new CustomEvent('dispatch-crud-event',
                                        {
                                            'detail': {
                                                'selected': this.getAttribute('entityId'),
                                                'form': this.getAttribute('form'),
                                                'event': 'create-Edition-Form'
                                            }, "bubbles": true, "cancelable": true
                                        });
                                this.dispatchEvent(eventCreateForm);
                            });

                            //Event listener for the delete action
                            rw.addEventListener('action-Eliminar', function() {
                                this.className = "selected";
                                var eventCreateForm = new CustomEvent('dispatch-crud-event',
                                        {
                                            'detail': {
                                                'selected': this.getAttribute('entityId'),
                                                'form': this.getAttribute('form'),
                                                'event': 'create-Elimination-Form'
                                            }, "bubbles": true, "cancelable": true
                                        });
                                this.dispatchEvent(eventCreateForm);
                            });
                        }
                    }
                },

                //According to the actionFileds this function creates the edition cells of each row
                createEditionRows(body, rowName){
                    var cell = document.createElement("TD");
                    var cellContent;
                    this.addClass(cell, "actions");
                    for (var field in this.actionFields) {
                        var createAction = "createActionButton" + this.actionFields[field];
                        cellContent = this[createAction]();
                        cell.appendChild(cellContent);
                    }
                    body.rows[rowName].appendChild(cell);
                },

                //Creates a new edition button
                createActionButtonEdit(){
                    var button = new buttonElement('Editar', 'create', 'lightseagreen', this.form);
                    return button;
                },

                //Creates a new message button
                createActionButtonMessage(){
                    var button = new buttonElement('Mensaje', 'send', '#ECD078', this.form);
                    return button;
                },

                //create a new delete button
                createActionButtonDelete(){
                    var button = new buttonElement('Eliminar', 'delete', '#C02942');
                    return button;
                },

                toggleSearchCollapser: function() {
                    this.$.searchBar.toggle();
                }

            });
        })();

    </script>
</dom-module>
